version: 2
jobs:
  job-checkout-code:
    docker:
    - image: circleci/openjdk:8-jdk-browsers
    working_directory: ~/oscal-repo
    steps:
    - checkout
    - save_cache:
        key: checkout-{{ .Environment.CIRCLE_SHA1 }}
        paths:
        - ~/circleci-demo-workflows
    environment:
    - SAXON_VERSION: 9.9.0-1
  job-validate-metaschema:
    docker:
    - image: circleci/openjdk:8-jdk-browsers
    working_directory: ~/oscal-repo
    steps:
    - restore_cache:
        key: checkout-{{ .Environment.CIRCLE_SHA1 }}
    - run:
        name: Get xmllint
        command: |
          sudo apt-get install libxml2-utils
    - run:
        name: validate metaschema instances
        command: echo "test"
    environment:
    - SAXON_VERSION: 9.9.0-1
  job-build-metaschema:
    working_directory: ~/oscal-metaschema
    docker:
    - image: circleci/openjdk:8-jdk-browsers
    steps:
    - checkout
    - run:
        name: Get Saxon
        command: mvn org.apache.maven.plugins:maven-dependency-plugin:2.4:get -DartifactId=Saxon-HE
          -DgroupId=net.sf.saxon -Dversion=9.9.0-1
    - run:
        name: Generate OSCAL Catalog Artifacts
        working_directory: ~/oscal-metaschema/schema/metaschema
        command: bash ./run-metaschema.sh ./oscal-catalog-metaschema.xml catalog
        environment:
          SAXON: /home/circleci/.m2/repository/net/sf/saxon/Saxon-HE/9.9.0-1/Saxon-HE-9.9.0-1.jar
    - run:
        name: Generate OSCAL Profile Artifacts
        working_directory: ~/oscal-metaschema/schema/metaschema
        command: bash ./run-metaschema.sh ./oscal-profile-metaschema.xml profile
        environment:
          SAXON: ~/.m2/repository/net/sf/saxon/Saxon-HE/9.9.0-1/Saxon-HE-9.9.0-1.jar
    - run:
        name: List Generated OSCAL Catalog Artifacts
        working_directory: ~/oscal-metaschema
        command: git status
    - deploy:
        name: Commit Artifacts
        working_directory: ~/oscal-metaschema
        command: |
          git config user.name "Deployment Bot"
          git commit --allow-empty -m "Deploying built artifacts [ci skip]"
          git push
  job-build-docs:
    working_directory: ~/oscal-docs
    docker:
    - image: circleci/ruby:2.3.8-jessie-node
    steps:
    - checkout
    - run:
        name: Install Bundler
        command: |
          cd ~/oscal-docs/docs
          gem install bundler
          bundle install
    - run:
        name: Middleman exec
        command: |
          cd ~/oscal-docs/docs
          bundle exec middleman build --clean
    - run:
        name: Run deploy script
        command: |
          cd ~/oscal-docs/docs
          bash ./deploy.sh -v -m "Deploying site [ci skip]"
workflows:
  version: 2
  validate-metaschema:
    jobs:
    - job-checkout-code
    - job-validate-metaschema:
        requires:
        - job-checkout-code
  build-site:
    jobs:
    - job-build-metaschema
    - job-build-docs:
        requires:
        - job-build-metaschema
  build-repo:
    jobs:
    - job-build-metaschema

# Original config.yml file:
# version: 2.1 # use CircleCI 2.1
# commands:
#   install-saxon:
#     description: \"Retrieve Saxon-HE and setup the environment to run it\"
#     steps:
#       - run:
#           name: Get Saxon
#           command: |
#             source ./build/ci-cd/common-environment.sh
#             mvn org.apache.maven.plugins:maven-dependency-plugin:2.4:get -DartifactId=Saxon-HE -DgroupId=net.sf.saxon -Dversion=$SAXON_VERSION
#   install-xmllint:
#     description: \"Retrieve xmllint and setup the environment to run it\"
#     steps:
#       - run:
#           name: Get xmllint
#           command: |
#             sudo apt-get install libxml2-utils
# executors:
#   java-executor:
#     docker: # run the steps with Docker
#       - image: circleci/openjdk:8-jdk-browsers
#     working_directory: ~/oscal-repo
#     environment:
#       SAXON_VERSION: 9.9.0-1
# 
# jobs: # a collection of steps
#   job-checkout-code:
#     executor: java-executor
#     steps:
#       - checkout
#       - save_cache:
#           key: checkout-{{ .Environment.CIRCLE_SHA1 }}
#           paths:
#             - ~/circleci-demo-workflows
#   job-validate-metaschema:
#     executor: java-executor
#     steps:
#      - restore_cache:
#          key: checkout-{{ .Environment.CIRCLE_SHA1 }}
#      - install-xmllint
#      - run:
#          name: validate metaschema instances
#          command: echo \"test\"
# 
#   job-build-metaschema:
#     working_directory: ~/oscal-metaschema # directory where steps will run
# 
#     docker: # run the steps with Docker
#       - image: circleci/openjdk:8-jdk-browsers
# 
#     steps: # a collection of executable commands
#       - checkout # check out source code to working directory
#       - run:
#           name: Get Saxon
#           command: mvn org.apache.maven.plugins:maven-dependency-plugin:2.4:get -DartifactId=Saxon-HE -DgroupId=net.sf.saxon -Dversion=9.9.0-1
#       - run:
#           name: Generate OSCAL Catalog Artifacts
#           working_directory: ~/oscal-metaschema/schema/metaschema
#           command: bash ./run-metaschema.sh ./oscal-catalog-metaschema.xml catalog
#           environment:
#             SAXON: /home/circleci/.m2/repository/net/sf/saxon/Saxon-HE/9.9.0-1/Saxon-HE-9.9.0-1.jar
#       - run:
#           name: Generate OSCAL Profile Artifacts
#           working_directory: ~/oscal-metaschema/schema/metaschema
#           command: bash ./run-metaschema.sh ./oscal-profile-metaschema.xml profile
#           environment:
#             SAXON: ~/.m2/repository/net/sf/saxon/Saxon-HE/9.9.0-1/Saxon-HE-9.9.0-1.jar
#       - run:   
#           name: List Generated OSCAL Catalog Artifacts
#           working_directory: ~/oscal-metaschema
#           command: git status
#       - deploy:
#           name: Commit Artifacts
#           working_directory: ~/oscal-metaschema
#           command: |
#             git config user.name \"Deployment Bot\"
#             git commit --allow-empty -m \"Deploying built artifacts [ci skip]\"
#             git push
#   job-build-docs:
#     working_directory: ~/oscal-docs # directory where steps will run
# 
#     docker: # run the steps with Docker
#       - image: circleci/ruby:2.3.8-jessie-node
# 
#     steps: # a collection of executable commands
#       - checkout # check out source code to working directory
#       - run:
#           name: Install Bundler
#           command: |
#             cd ~/oscal-docs/docs
#             gem install bundler
#             bundle install
#       - run:
#           name: Middleman exec
#           command: |
#             cd ~/oscal-docs/docs
#             bundle exec middleman build --clean
#       - run:
#           name: Run deploy script
#           command: |
#             cd ~/oscal-docs/docs
#             bash ./deploy.sh -v -m \"Deploying site [ci skip]\"
# workflows:
#   version: 2
#   validate-metaschema:
#     jobs:
#       - job-checkout-code
#       - job-validate-metaschema:
#           requires:
#             - job-checkout-code
#   build-site:
#     jobs:
#       - job-build-metaschema
#       - job-build-docs:
#           requires:
#             - job-build-metaschema
#   build-repo:
#     jobs:
#       - job-build-metaschema